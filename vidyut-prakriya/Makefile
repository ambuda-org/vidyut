# Build
# -----

# Verifies that everything builds.
build_all:
	cargo build --examples


# Unit tests
# ~~~~~~~~~~

# Runs all unit tests in the crate.
unit_tests:
	cargo nextest run --no-fail-fast --status-level=fail

# Generates a simple coverage report and writes it to disk as an HTML file.
coverage:
	cargo llvm-cov --html


# Integration tests
# ~~~~~~~~~~~~~~~~~

# Generates all tinantas, krdantas, and dhatus supported by the program and writes them to disk.
create_test_files:
	cargo run --release --example snapshot_tests create --output-dir test-files

# Runs a full evaluation over all forms generated by vidyut-prakriya. `hash` is
# the SHA-256 hash of the test file. We use `hash` to verify test file
# integrity and ensure that our test cases are stable.
#
# NOTE: test files might contain invalid forms. Our goal with this test is
# simply to confirm that the system hasn't changed in unexpected ways.
test_all: test_tinantas test_krdantas test_dhatus

test_tinantas:
	cargo run --release --example snapshot_tests validate \
		--test-type tinantas \
		-f test-files/tinantas-basic.msgpack \
		-h "1ca53f0f7612728943699d20b5e42d80ca340ed330102cdede1e2e3b8af9e973" \
		-f test-files/tinantas-nic.msgpack \
		-h "a8b186ff62fe20a08e147537614bbb3220fbfd8d2fce356514e5e595d1e579fb" \
		-f test-files/tinantas-san.msgpack \
		-h "6a5180111ba24c8a6cbdb9257990438c816515b5102193449857ab20bd07164e" \
		-f test-files/tinantas-yan.msgpack \
		-h "0ba293917913f2aed9423ea3125071c56426ca2fc9e06a2632f27297de4b0139" \
		-f test-files/tinantas-yan-luk.msgpack \
		-h "871c631461aa2ab1ded884de5bdf12464879f5da46c660c3076c333a3a90fd7f" \
		-f test-files/tinantas-san-nic.msgpack \
		-h "66b82321c244f4369422b06c2db9254d61a680eceeb6e9c0e8b8ac24a274b3c8" \
		-f test-files/tinantas-nic-san.msgpack \
		-h "c84fc7a9cfce47561b5075f974f5fae4a2820549336c344a97978f719c01e409"

test_krdantas:
	cargo run --release --example snapshot_tests validate \
		--test-type krdantas \
		-f test-files/krdantas-basic.msgpack \
		-h "a9f8335433aaabf6497a3bd3c8bbfd5bc1f42cc4f3398eb93ce606e825cd9449" \
		-f test-files/krdantas-nic.msgpack \
		-h "c0eeacf5c5d987148aab0d08c5c6c63b5220d69014f2f2cff84d488ffbd4906b" \
		-f test-files/krdantas-san.msgpack \
		-h "0a3650fb93ac3d5893d88a1bbd1e517e65ff1c8ac4f87187248e15a9bb689ea7" \
		-f test-files/krdantas-yan.msgpack \
		-h "e8b244e52be039dd8efaaa5fc274150b4550cc74a09e33b45d0bfd22b70c9b2a" \
		-f test-files/krdantas-yan-luk.msgpack \
		-h "62a0366f77543a2a17b5aa0806b42c1855ee1e85fe33e011c3284e87eecbe4a7" \
		-f test-files/krdantas-san-nic.msgpack \
		-h "e28a61e8c3e078c4d2ddae93e78ab5fb8ed44d700f2ae55ca72d9ae9544b6f58" \
		-f test-files/krdantas-nic-san.msgpack \
		-h "292154fceae7d2821420076949d9df89564f6f7fc9e38a00298363f9116cef63"

test_dhatus:
	cargo run --release --example snapshot_tests validate \
		--test-type dhatus \
		-f test-files/dhatus.msgpack \
		-h "b76f6643625ca659b4fb7e7dd8534d9204237ec20c512943a4d87441ec938dae"


test_subantas:
	cargo run --bin test_subantas -- \
		--test-cases test-files/subantas.csv

check_rule_coverage:
	./scripts/check_rule_coverage.py > report.log 


# Performance
# ~~~~~~~~~~~

# Profiles the program's execution time on OSX. This command will probably not
# work on other operating systems.
profile-time-osx:
	cargo instruments -t time --release --example bench


# Other
# ~~~~~

# Generates project docs and opens them in your default browser.
docs:
	cargo doc --no-deps --open


# Web builds
# ----------

# Builds WASM module and JS wrapper (pkg/vidyut_prakriya.js).
#
# This is a release build. Creating it will be slower but smaller and (perhaps)
# more performant.
wasm_release:
	wasm-pack build --target web --release -- --features serde

# Builds WASM module and JS wrapper (pkg/vidyut_prakriya.js).
#
# This is a dev build. Creating it will be faster, but size and performance
# will not be optimized.
wasm_dev:
	wasm-pack build --target web -- --features serde

# Builds a simple web debugger.
debugger:
	./scripts/run-debugger.sh
