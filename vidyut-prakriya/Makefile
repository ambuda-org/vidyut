# Main commands
# ~~~~~~~~~~~~~

# Generates all tinantas supported by the program and writes them to stdout.
create_tinantas:
	cargo run --release --bin create_tinantas


# Generates all krdantas-prAtipadikas supported by the program and writes them to stdout.
create_krdantas:
	cargo run --release --bin create_krdantas


# Unit tests
# ~~~~~~~~~~

# Runs all unit tests in the crate.
unit_tests:
	cargo test --lib

# Generates a simple coverage report and writes it to disk as an HTML file.
coverage:
	cargo llvm-cov --html


# Integration tests
# ~~~~~~~~~~~~~~~~~

# Generates all tinantas supported by the program and writes them to disk.
create_test_files:
	cargo build --release
	../target/release/create_tinantas --prayoga kartari > test-files/tinantas-basic-kartari.csv
	../target/release/create_tinantas --sanadi Ric --prayoga kartari > test-files/tinantas-nic-kartari.csv
	../target/release/create_tinantas --sanadi san --prayoga kartari > test-files/tinantas-san-kartari.csv
	../target/release/create_tinantas --sanadi yaN --prayoga kartari > test-files/tinantas-yan-kartari.csv
	../target/release/create_tinantas --prayoga karmani > test-files/tinantas-basic-karmani.csv
	../target/release/create_krdantas --krt ktvA > test-files/krdantas-ktvA.csv
	../target/release/create_krdantas --krt kta > test-files/krdantas-kta.csv

create_subantas:
	# Work-in-progress tests for subantas.
	cargo run --bin create_subantas > test-files/subantas.csv

# Runs a full evaluation over all forms generated by vidyut-prakriya. `hash` is
# the SHA-256 hash of the test file. We use `hash` to verify test file
# integrity and ensure that our test cases are stable.
#
# NOTE: test files might contain invalid forms. Our goal with this test is
# simply to confirm that the system hasn't changed in unexpected ways.
test_all: test_tinantas test_krdantas

test_tinantas:
	cargo build --release
	../target/release/test_tinantas \
		--test-cases test-files/tinantas-basic-kartari.csv \
	    --hash "2cb9791994862818fbfd2438a375f7bbb9f863c493443528ae8459b56d159b9c"
	../target/release/test_tinantas \
		--test-cases test-files/tinantas-nic-kartari.csv \
	    --hash "b87f2e09900a9eaee5d0664f525b14b00ef5c933360d18e2df0f865775691dbe"
	../target/release/test_tinantas \
		--test-cases test-files/tinantas-san-kartari.csv \
	    --hash "4f10c2e732aa10a682418661abc111d240e5b94a10dc24e1a92c2161c2d1e967"
	../target/release/test_tinantas \
		--test-cases test-files/tinantas-yan-kartari.csv \
	    --hash "6b074a579727e5a606edf8890a31d9f33f38bf8fd3b21a97d32e4a47b582ec14"
	../target/release/test_tinantas \
		--test-cases test-files/tinantas-basic-karmani.csv \
	    --hash "28fd9f7d49cc0e66af7a5940e4d3c89c67eecd1158438644cba0c9330ad6375d"

test_krdantas:
	cargo build --release
	../target/release/test_krdantas \
		--test-cases test-files/krdantas-ktvA.csv \
	    --hash "0e3fc140599a0a13929da421ba171d2ccf54114d28df8afc9103783d33c7c08d"
	../target/release/test_krdantas \
		--test-cases test-files/krdantas-kta.csv \
	    --hash "c764e2561c1c36070165caffab562f1e8e159be73ec49a5f26e14e047a225121"

test_subantas:
	cargo run --bin test_subantas -- \
		--test-cases test-files/subantas.csv
	    # --hash "56a068a1abd7518f3d1fd6421e1676c4b375011cbd1ae3bd6c6d147d2f9e6013"


# Performance
# ~~~~~~~~~~~

# Profiles the program's execution time on OSX. This command will probably not
# work on other operating systems.
profile-time-osx:
	cargo instruments -t time --release --bin create_test_file


# Other
# ~~~~~

# Generates project docs and opens them in your default browser.
docs:
	cargo doc --no-deps --open


# Web builds
# ----------

# Builds WASM module and JS wrapper (pkg/vidyut_prakriya.js).
#
# This is a release build. Creating it will be slower but smaller and (perhaps)
# more performant.
wasm_release:
	wasm-pack build --target web --release

# Builds WASM module and JS wrapper (pkg/vidyut_prakriya.js).
#
# This is a dev build. Creating it will be faster, but size and performance
# will not be optimized.
wasm_dev:
	wasm-pack build --target web

# Builds a simple web debugger.
debugger: wasm_dev
	mkdir -p www/static/wasm && cp pkg/* www/static/wasm
	mkdir -p www/static/data && cp data/* www/static/data
	cd www \
		&& python3 -m venv env \
		&& . env/bin/activate \
		&& pip3 install -r requirements.txt \
		&& python app.py
